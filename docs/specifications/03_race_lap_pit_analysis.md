# æœ¬æˆ¦åˆ†æ: ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ ã¨ãƒ”ãƒƒãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®å¯è¦–åŒ– ä»•æ§˜æ›¸

## 1. æ¦‚è¦
æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€F1æœ¬æˆ¦ã«ãŠã‘ã‚‹ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ ã¨ãƒ”ãƒƒãƒˆã‚¹ãƒˆãƒƒãƒ—ã®å¯è¦–åŒ–æ©Ÿèƒ½ã®è©³ç´°ä»•æ§˜ã‚’å®šç¾©ã—ã¾ã™ã€‚

---

## 2. æ©Ÿèƒ½æ¦‚è¦

### 2.1 ç›®çš„
- ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã”ã¨ã®ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ æ¨ç§»ã‚’å¯è¦–åŒ–
- ãƒ”ãƒƒãƒˆã‚¹ãƒˆãƒƒãƒ—ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨æˆ¦ç•¥ã‚’åˆ†æ
- ã‚¢ãƒ³ãƒ€ãƒ¼ã‚«ãƒƒãƒˆãƒ»ã‚ªãƒ¼ãƒãƒ¼ã‚«ãƒƒãƒˆã®æˆåŠŸ/å¤±æ•—ã‚’åˆ¤å®š
- ã‚¿ã‚¤ãƒ¤ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ãƒ‡ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¯è¦–åŒ–

### 2.2 ç”»é¢æ§‹æˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ˜ãƒƒãƒ€ãƒ¼: ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ± (ã‚µãƒ¼ã‚­ãƒƒãƒˆåã€æ—¥ä»˜ã€å¤©å€™)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ãƒ•ã‚£ãƒ«ã‚¿ãƒ‘ãƒãƒ«: ãƒ‰ãƒ©ã‚¤ãƒãƒ¼é¸æŠã€ã‚¿ã‚¤ãƒ¤ã‚³ãƒ³ãƒ‘ã‚¦ãƒ³ãƒ‰é¸æŠ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ã€ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ æ¨ç§»ã‚°ãƒ©ãƒ•ã€‘                                â”‚
â”‚   - æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼ˆãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã”ã¨ã«è‰²åˆ†ã‘ï¼‰                  â”‚
â”‚   - ãƒ”ãƒƒãƒˆã‚¹ãƒˆãƒƒãƒ—ã‚’ãƒãƒ¼ã‚«ãƒ¼ã§è¡¨ç¤º                         â”‚
â”‚                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ã€ãƒ”ãƒƒãƒˆæˆ¦ç•¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã€‘                                â”‚
â”‚   - ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã”ã¨ã®ã‚¹ãƒ†ã‚£ãƒ³ãƒˆï¼ˆã‚¿ã‚¤ãƒ¤ä½¿ç”¨åŒºé–“ï¼‰ã‚’è¦–è¦šåŒ–    â”‚
â”‚   - ã‚¿ã‚¤ãƒ¤ã‚³ãƒ³ãƒ‘ã‚¦ãƒ³ãƒ‰ã‚’è‰²åˆ†ã‘è¡¨ç¤º                         â”‚
â”‚                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ã€ã‚¿ã‚¤ãƒ¤ãƒ‡ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æã€‘                             â”‚
â”‚   - ã‚¹ãƒ†ã‚£ãƒ³ãƒˆã”ã¨ã®ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ åŠ£åŒ–ã‚’å¯è¦–åŒ–                â”‚
â”‚                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ã€ãƒ”ãƒƒãƒˆã‚¹ãƒˆãƒƒãƒ—è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ã€‘                             â”‚
â”‚   - ãƒ”ãƒƒãƒˆã‚¤ãƒ³ãƒ©ãƒƒãƒ—ã€ãƒ­ã‚¹ã‚¿ã‚¤ãƒ ã€ã‚¿ã‚¤ãƒ¤äº¤æ›è©³ç´°            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ æ¨ç§»ã‚°ãƒ©ãƒ•

### 3.1 ãƒ‡ãƒ¼ã‚¿è¦ä»¶

#### å¿…è¦ãªAPIãƒ‡ãƒ¼ã‚¿
```typescript
// ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿
interface Lap {
  lap_number: number;
  lap_duration: number; // ç§’
  driver_number: number;
  is_pit_out_lap: boolean;
  date_start: string;
  segments_sector_1: number[];
  segments_sector_2: number[];
  segments_sector_3: number[];
}

// ãƒ”ãƒƒãƒˆã‚¹ãƒˆãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿
interface PitStop {
  lap_number: number;
  driver_number: number;
  pit_duration: number; // ç§’
  date: string;
}

// ã‚¹ãƒ†ã‚£ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿
interface Stint {
  driver_number: number;
  stint_number: number;
  lap_start: number;
  lap_end: number;
  compound: 'SOFT' | 'MEDIUM' | 'HARD' | 'INTERMEDIATE' | 'WET';
  tyre_age_at_start: number;
}
```

#### ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ•ãƒ­ãƒ¼
```typescript
// 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚­ãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
const sessionKey = 9158; // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—

// 2. ä¸¦è¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒ
const { data: laps } = useQuery({
  queryKey: ['laps', sessionKey],
  queryFn: () => f1Api.laps.getLapsBySession(sessionKey),
});

const { data: pitStops } = useQuery({
  queryKey: ['pitStops', sessionKey],
  queryFn: () => f1Api.pit.getPitStopsBySession(sessionKey),
});

const { data: stints } = useQuery({
  queryKey: ['stints', sessionKey],
  queryFn: () => f1Api.stints.getStintsBySession(sessionKey),
});

const { data: drivers } = useQuery({
  queryKey: ['drivers', sessionKey],
  queryFn: () => f1Api.drivers.getDriversBySession(sessionKey),
});
```

### 3.2 ã‚°ãƒ©ãƒ•ä»•æ§˜

#### ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—
- **Recharts LineChart**
- è¤‡æ•°ãƒ©ã‚¤ãƒ³ã®é‡ã­åˆã‚ã›
- ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—

#### è»¸è¨­å®š
```typescript
// Xè»¸: ãƒ©ãƒƒãƒ—ç•ªå·
{
  dataKey: 'lap_number',
  type: 'number',
  domain: [1, 'dataMax'],
  label: { value: 'Lap', position: 'insideBottom', offset: -5 },
  allowDecimals: false,
}

// Yè»¸: ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ ï¼ˆç§’ï¼‰
{
  type: 'number',
  domain: ['dataMin - 5', 'dataMax + 5'],
  label: { value: 'Lap Time (s)', angle: -90, position: 'insideLeft' },
  tickFormatter: (value) => value.toFixed(1),
}
```

#### ãƒ©ã‚¤ãƒ³è¨­å®š
```typescript
// ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã”ã¨ã«Lineã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
{
  drivers.map(driver => (
    <Line
      key={driver.driver_number}
      type="monotone"
      dataKey={`driver_${driver.driver_number}`}
      stroke={`#${driver.team_colour}`}
      strokeWidth={selectedDrivers.includes(driver.driver_number) ? 3 : 1}
      dot={false} // é€šå¸¸ã®ãƒ©ãƒƒãƒ—ã¯ãƒ‰ãƒƒãƒˆéè¡¨ç¤º
      activeDot={{ r: 6 }} // ãƒ›ãƒãƒ¼æ™‚ã¯è¡¨ç¤º
      connectNulls={false} // ãƒ”ãƒƒãƒˆãƒ©ãƒƒãƒ—ã¯æ¥ç¶šã—ãªã„
    />
  ))
}
```

#### ãƒ”ãƒƒãƒˆã‚¹ãƒˆãƒƒãƒ—ãƒãƒ¼ã‚«ãƒ¼
```typescript
// ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒƒãƒˆã§ãƒ”ãƒƒãƒˆã‚¹ãƒˆãƒƒãƒ—ã‚’è¡¨ç¤º
const CustomDot = (props: any) => {
  const { cx, cy, payload, dataKey } = props;
  const driverNumber = parseInt(dataKey.split('_')[1]);
  const isPitLap = pitStops.some(
    pit => pit.driver_number === driverNumber && pit.lap_number === payload.lap_number
  );

  if (!isPitLap) return null;

  return (
    <circle
      cx={cx}
      cy={cy}
      r={6}
      fill="orange"
      stroke="white"
      strokeWidth={2}
    />
  );
};
```

#### ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
```typescript
const CustomTooltip = ({ active, payload, label }: any) => {
  if (!active || !payload || !payload.length) return null;

  return (
    <div className="bg-white p-4 border border-gray-200 rounded shadow-lg">
      <p className="font-bold">Lap {label}</p>
      {payload.map((entry: any) => {
        const driverNumber = parseInt(entry.dataKey.split('_')[1]);
        const driver = drivers.find(d => d.driver_number === driverNumber);
        const pitStop = pitStops.find(
          p => p.driver_number === driverNumber && p.lap_number === label
        );

        return (
          <div key={entry.dataKey} className="mt-2">
            <p style={{ color: entry.color }}>
              {driver?.name_acronym}: {entry.value.toFixed(3)}s
            </p>
            {pitStop && (
              <p className="text-sm text-orange-600">
                ğŸ”§ Pit: {pitStop.pit_duration.toFixed(1)}s
              </p>
            )}
          </div>
        );
      })}
    </div>
  );
};
```

### 3.3 ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯

#### ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢
```typescript
// ãƒ‰ãƒ©ã‚¤ãƒãƒ¼åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã€ãƒ”ãƒƒãƒˆã‚¢ã‚¦ãƒˆãƒ©ãƒƒãƒ—ã‚’é™¤å¤–
function processLapData(laps: Lap[], selectedDrivers: number[]) {
  const lapsByDriver = laps
    .filter(lap => selectedDrivers.includes(lap.driver_number))
    .reduce((acc, lap) => {
      if (!acc[lap.driver_number]) {
        acc[lap.driver_number] = [];
      }
      acc[lap.driver_number].push(lap);
      return acc;
    }, {} as Record<number, Lap[]>);

  // å…¨ãƒ©ãƒƒãƒ—æ•°ã‚’å–å¾—
  const maxLap = Math.max(...laps.map(l => l.lap_number));

  // ãƒ©ãƒƒãƒ—ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢
  const chartData = [];
  for (let lapNum = 1; lapNum <= maxLap; lapNum++) {
    const dataPoint: any = { lap_number: lapNum };

    selectedDrivers.forEach(driverNum => {
      const lap = lapsByDriver[driverNum]?.find(l => l.lap_number === lapNum);

      // ãƒ”ãƒƒãƒˆã‚¢ã‚¦ãƒˆãƒ©ãƒƒãƒ—ã¯é™¤å¤–ï¼ˆã‚°ãƒ©ãƒ•ã®é€£ç¶šæ€§ã‚’ä¿ã¤ï¼‰
      if (lap && !lap.is_pit_out_lap && lap.lap_duration) {
        dataPoint[`driver_${driverNum}`] = lap.lap_duration;
      } else {
        dataPoint[`driver_${driverNum}`] = null;
      }
    });

    chartData.push(dataPoint);
  }

  return chartData;
}
```

### 3.4 ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½

#### ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ãƒ•ã‚£ãƒ«ã‚¿
- URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `drivers` ã‹ã‚‰é¸æŠçŠ¶æ…‹ã‚’å–å¾—
- é¸æŠã•ã‚ŒãŸãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®ã¿ã‚°ãƒ©ãƒ•ã«è¡¨ç¤º
- é¸æŠè§£é™¤ã•ã‚ŒãŸãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¯è–„ãè¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

#### ãƒ©ãƒƒãƒ—ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿
```typescript
interface LapRangeFilter {
  startLap: number;
  endLap: number;
}

// URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: ?lapStart=10&lapEnd=30
const lapRange = {
  startLap: parseInt(searchParams.get('lapStart') || '1'),
  endLap: parseInt(searchParams.get('lapEnd') || String(maxLap)),
};
```

---

## 4. ãƒ”ãƒƒãƒˆæˆ¦ç•¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

### 4.1 è¦–è¦šè¡¨ç¾

#### ã‚¹ãƒ†ã‚£ãƒ³ãƒˆãƒãƒ¼
```
Driver 1: [SOFTâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] [MEDIUMâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] [SOFTâ–ˆâ–ˆâ–ˆâ–ˆ]
Driver 2: [MEDIUMâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] [SOFTâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
Driver 3: [SOFTâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] [HARDâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
         Lap 1      10       20       30       40       50
```

### 4.2 UIä»•æ§˜

#### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ
```typescript
<div className="space-y-2">
  {selectedDrivers.map(driverNum => {
    const driverStints = stints.filter(s => s.driver_number === driverNum);
    const driver = drivers.find(d => d.driver_number === driverNum);

    return (
      <div key={driverNum} className="flex items-center gap-2">
        {/* ãƒ‰ãƒ©ã‚¤ãƒãƒ¼æƒ…å ± */}
        <div className="w-24 text-sm font-medium">
          {driver?.name_acronym}
        </div>

        {/* ã‚¹ãƒ†ã‚£ãƒ³ãƒˆãƒãƒ¼ */}
        <div className="flex-1 flex relative h-8">
          {driverStints.map(stint => {
            const width = ((stint.lap_end - stint.lap_start + 1) / maxLap) * 100;
            const left = ((stint.lap_start - 1) / maxLap) * 100;

            return (
              <div
                key={stint.stint_number}
                className="absolute h-full rounded"
                style={{
                  left: `${left}%`,
                  width: `${width}%`,
                  backgroundColor: getTyreColor(stint.compound),
                }}
                title={`${stint.compound} (Lap ${stint.lap_start}-${stint.lap_end})`}
              >
                <span className="text-xs text-white px-1">
                  {stint.compound[0]}
                </span>
              </div>
            );
          })}
        </div>
      </div>
    );
  })}
</div>

// ã‚¿ã‚¤ãƒ¤ã‚³ãƒ³ãƒ‘ã‚¦ãƒ³ãƒ‰è‰²
function getTyreColor(compound: TireCompound): string {
  const colors = {
    SOFT: '#FF0000',      // èµ¤
    MEDIUM: '#FFFF00',    // é»„
    HARD: '#FFFFFF',      // ç™½
    INTERMEDIATE: '#00FF00', // ç·‘
    WET: '#0000FF',       // é’
  };
  return colors[compound];
}
```

### 4.3 ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³

#### ãƒ›ãƒãƒ¼è¡¨ç¤º
```typescript
// ã‚¹ãƒ†ã‚£ãƒ³ãƒˆãƒãƒ¼ã«ãƒ›ãƒãƒ¼ã§ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤º
<Tooltip>
  <TooltipTrigger asChild>
    <div className="stint-bar">...</div>
  </TooltipTrigger>
  <TooltipContent>
    <p>Compound: {stint.compound}</p>
    <p>Laps: {stint.lap_start} - {stint.lap_end}</p>
    <p>Stint Length: {stint.lap_end - stint.lap_start + 1} laps</p>
    <p>Tyre Age: {stint.tyre_age_at_start} laps old</p>
  </TooltipContent>
</Tooltip>
```

#### ã‚¯ãƒªãƒƒã‚¯æ“ä½œ
- ã‚¹ãƒ†ã‚£ãƒ³ãƒˆãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ è©²å½“ãƒ©ãƒƒãƒ—ç¯„å›²ã«ã‚ºãƒ¼ãƒ 
- URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ›´æ–°: `?lapStart=10&lapEnd=25`

---

## 5. ã‚¢ãƒ³ãƒ€ãƒ¼ã‚«ãƒƒãƒˆãƒ»ã‚ªãƒ¼ãƒãƒ¼ã‚«ãƒƒãƒˆåˆ†æ

### 5.1 å®šç¾©

#### ã‚¢ãƒ³ãƒ€ãƒ¼ã‚«ãƒƒãƒˆ
å…ˆã«ãƒ”ãƒƒãƒˆã‚¤ãƒ³ã—ã¦æ–°ã—ã„ã‚¿ã‚¤ãƒ¤ã§è¿½ã„æŠœãæˆ¦ç•¥
```
ä¾‹:
Driver A: Lap 20ã§ãƒ”ãƒƒãƒˆ (15ä½ â†’ 18ä½ã«ä¸€æ™‚é™æ ¼)
Driver B: Lap 22ã§ãƒ”ãƒƒãƒˆ (14ä½)
â†’ Driver AãŒæ–°å“ã‚¿ã‚¤ãƒ¤ã§é€Ÿã„ãƒ©ãƒƒãƒ— â†’ Lap 23ã«14ä½ã«æµ®ä¸Š
â†’ ã‚¢ãƒ³ãƒ€ãƒ¼ã‚«ãƒƒãƒˆæˆåŠŸ
```

#### ã‚ªãƒ¼ãƒãƒ¼ã‚«ãƒƒãƒˆ
å¾Œã«ãƒ”ãƒƒãƒˆã‚¤ãƒ³ã—ã¦ã‚¿ã‚¤ãƒ¤æ¸©å­˜ã§è¿½ã„æŠœãæˆ¦ç•¥
```
ä¾‹:
Driver A: Lap 20ã§ãƒ”ãƒƒãƒˆ
Driver B: Lap 25ã§ãƒ”ãƒƒãƒˆ (ã‚¿ã‚¤ãƒ¤ã‚’é•·ãä½¿ã†)
â†’ Driver BãŒãƒ”ãƒƒãƒˆå¾Œã‚‚Driver Aã‚ˆã‚Šå‰ã®é †ä½
â†’ ã‚ªãƒ¼ãƒãƒ¼ã‚«ãƒƒãƒˆæˆåŠŸ
```

### 5.2 åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

```typescript
interface PitStrategyAnalysis {
  driver1: number;
  driver2: number;
  type: 'undercut' | 'overcut';
  success: boolean;
  driver1PitLap: number;
  driver2PitLap: number;
  positionChange: number;
}

function analyzePitStrategy(
  positions: Position[],
  pitStops: PitStop[]
): PitStrategyAnalysis[] {
  const results: PitStrategyAnalysis[] = [];

  // ãƒ”ãƒƒãƒˆå‰å¾Œ3ãƒ©ãƒƒãƒ—ã§ã®é †ä½å¤‰å‹•ã‚’åˆ†æ
  pitStops.forEach(pit1 => {
    pitStops.forEach(pit2 => {
      if (pit1.driver_number === pit2.driver_number) return;
      if (Math.abs(pit1.lap_number - pit2.lap_number) > 5) return; // è¿‘ã„ãƒ©ãƒƒãƒ—ã®ã¿

      const lapDiff = pit2.lap_number - pit1.lap_number;
      if (lapDiff <= 0) return;

      // ãƒ”ãƒƒãƒˆå‰ã®é †ä½
      const beforePos1 = positions.find(
        p => p.driver_number === pit1.driver_number &&
             p.lap_number === pit1.lap_number - 1
      )?.position;

      const beforePos2 = positions.find(
        p => p.driver_number === pit2.driver_number &&
             p.lap_number === pit1.lap_number - 1
      )?.position;

      // ãƒ”ãƒƒãƒˆå¾Œã®é †ä½ï¼ˆä¸¡æ–¹ãŒãƒ”ãƒƒãƒˆå¾Œï¼‰
      const afterPos1 = positions.find(
        p => p.driver_number === pit1.driver_number &&
             p.lap_number === pit2.lap_number + 2
      )?.position;

      const afterPos2 = positions.find(
        p => p.driver_number === pit2.driver_number &&
             p.lap_number === pit2.lap_number + 2
      )?.position;

      if (!beforePos1 || !beforePos2 || !afterPos1 || !afterPos2) return;

      // ã‚¢ãƒ³ãƒ€ãƒ¼ã‚«ãƒƒãƒˆåˆ¤å®šï¼ˆå…ˆã«ãƒ”ãƒƒãƒˆã—ãŸæ–¹ãŒé †ä½ã‚’ä¸Šã’ãŸï¼‰
      if (beforePos1 > beforePos2 && afterPos1 < afterPos2) {
        results.push({
          driver1: pit1.driver_number,
          driver2: pit2.driver_number,
          type: 'undercut',
          success: true,
          driver1PitLap: pit1.lap_number,
          driver2PitLap: pit2.lap_number,
          positionChange: beforePos1 - afterPos1,
        });
      }
    });
  });

  return results;
}
```

### 5.3 è¦–è¦šåŒ–

#### ã‚°ãƒ©ãƒ•ä¸Šã®è¡¨ç¤º
```typescript
// ã‚¢ãƒ³ãƒ€ãƒ¼ã‚«ãƒƒãƒˆæˆåŠŸæ™‚ã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
<ReferenceArea
  x1={strategy.driver1PitLap}
  x2={strategy.driver2PitLap + 2}
  y1="dataMin"
  y2="dataMax"
  fill="green"
  fillOpacity={0.1}
  label={{
    value: 'ğŸŸ¢ Undercut Success',
    position: 'insideTop'
  }}
/>
```

#### ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰
```typescript
<div className="bg-green-50 border border-green-200 rounded p-4">
  <h3 className="font-bold text-green-800">Undercut Success</h3>
  <p>
    {getDriver(strategy.driver1).name_acronym} undercut{' '}
    {getDriver(strategy.driver2).name_acronym}
  </p>
  <p className="text-sm text-gray-600">
    Lap {strategy.driver1PitLap} â†’ {strategy.driver2PitLap}
    ({strategy.driver2PitLap - strategy.driver1PitLap} laps earlier)
  </p>
  <p className="text-sm text-gray-600">
    Position gained: {strategy.positionChange}
  </p>
</div>
```

---

## 6. ã‚¿ã‚¤ãƒ¤ãƒ‡ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æ

### 6.1 ãƒ‡ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©
ã‚¿ã‚¤ãƒ¤ã®æ‘©è€—ã«ã‚ˆã‚‹ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ ã®åŠ£åŒ–

### 6.2 è¨ˆç®—æ–¹æ³•

```typescript
interface TyreDegradation {
  driver_number: number;
  stint_number: number;
  compound: TireCompound;
  degradation_per_lap: number; // ç§’/ãƒ©ãƒƒãƒ—
  total_degradation: number;   // ã‚¹ãƒ†ã‚£ãƒ³ãƒˆå…¨ä½“ã®åŠ£åŒ–
  average_lap_time: number;
}

function calculateTyreDegradation(
  laps: Lap[],
  stints: Stint[]
): TyreDegradation[] {
  const results: TyreDegradation[] = [];

  stints.forEach(stint => {
    const stintLaps = laps.filter(
      lap =>
        lap.driver_number === stint.driver_number &&
        lap.lap_number >= stint.lap_start &&
        lap.lap_number <= stint.lap_end &&
        !lap.is_pit_out_lap &&
        lap.lap_duration !== null
    );

    if (stintLaps.length < 3) return; // æœ€ä½3ãƒ©ãƒƒãƒ—å¿…è¦

    // ç·šå½¢å›å¸°ã§åŠ£åŒ–ç‡ã‚’è¨ˆç®—
    const lapNumbers = stintLaps.map(l => l.lap_number - stint.lap_start);
    const lapTimes = stintLaps.map(l => l.lap_duration);

    const degradationPerLap = calculateLinearRegression(lapNumbers, lapTimes).slope;
    const averageLapTime = lapTimes.reduce((a, b) => a + b, 0) / lapTimes.length;
    const totalDegradation = degradationPerLap * (stint.lap_end - stint.lap_start);

    results.push({
      driver_number: stint.driver_number,
      stint_number: stint.stint_number,
      compound: stint.compound,
      degradation_per_lap: degradationPerLap,
      total_degradation: totalDegradation,
      average_lap_time: averageLapTime,
    });
  });

  return results;
}

// ç·šå½¢å›å¸°è¨ˆç®—
function calculateLinearRegression(x: number[], y: number[]) {
  const n = x.length;
  const sumX = x.reduce((a, b) => a + b, 0);
  const sumY = y.reduce((a, b) => a + b, 0);
  const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
  const sumXX = x.reduce((sum, xi) => sum + xi * xi, 0);

  const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
  const intercept = (sumY - slope * sumX) / n;

  return { slope, intercept };
}
```

### 6.3 è¦–è¦šåŒ–

#### ãƒ‡ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚°ãƒ©ãƒ•
```typescript
// ã‚¹ãƒ†ã‚£ãƒ³ãƒˆã”ã¨ã®ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ æ¨ç§»ï¼ˆåŠ£åŒ–ã‚’å¯è¦–åŒ–ï¼‰
<ResponsiveContainer width="100%" height={300}>
  <LineChart data={degradationData}>
    <XAxis
      dataKey="lap_in_stint"
      label={{ value: 'Laps on Tyre', position: 'insideBottom' }}
    />
    <YAxis
      label={{ value: 'Lap Time (s)', angle: -90, position: 'insideLeft' }}
    />
    <Tooltip content={<CustomDegradationTooltip />} />
    <Legend />

    {selectedDrivers.map(driverNum => (
      <Line
        key={driverNum}
        type="monotone"
        dataKey={`driver_${driverNum}`}
        stroke={getDriverColor(driverNum)}
        strokeWidth={2}
      />
    ))}

    {/* åŠ£åŒ–ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ */}
    {selectedDrivers.map(driverNum => (
      <Line
        key={`${driverNum}_trend`}
        type="monotone"
        dataKey={`driver_${driverNum}_trend`}
        stroke={getDriverColor(driverNum)}
        strokeWidth={1}
        strokeDasharray="5 5"
        dot={false}
      />
    ))}
  </LineChart>
</ResponsiveContainer>
```

#### ã‚³ãƒ³ãƒ‘ã‚¦ãƒ³ãƒ‰åˆ¥æ¯”è¼ƒãƒ†ãƒ¼ãƒ–ãƒ«
```typescript
<table className="w-full border-collapse">
  <thead>
    <tr className="bg-gray-100">
      <th>Driver</th>
      <th>Compound</th>
      <th>Avg Lap Time</th>
      <th>Degradation/Lap</th>
      <th>Total Degradation</th>
    </tr>
  </thead>
  <tbody>
    {degradationData.map(deg => (
      <tr key={`${deg.driver_number}_${deg.stint_number}`}>
        <td>{getDriver(deg.driver_number).name_acronym}</td>
        <td>
          <span
            className="px-2 py-1 rounded"
            style={{ backgroundColor: getTyreColor(deg.compound) }}
          >
            {deg.compound}
          </span>
        </td>
        <td>{deg.average_lap_time.toFixed(3)}s</td>
        <td>{deg.degradation_per_lap.toFixed(4)}s</td>
        <td>{deg.total_degradation.toFixed(3)}s</td>
      </tr>
    ))}
  </tbody>
</table>
```

---

## 7. ãƒ”ãƒƒãƒˆã‚¹ãƒˆãƒƒãƒ—è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«

### 7.1 è¡¨ç¤ºé …ç›®

```typescript
interface PitStopDetail {
  driver_number: number;
  driver_name: string;
  lap_number: number;
  pit_duration: number;
  tyre_change: {
    from: TireCompound;
    to: TireCompound;
  };
  position_before: number;
  position_after: number;
  position_change: number;
  time_lost: number; // ãƒ”ãƒƒãƒˆæ™‚é–“ + èµ°è¡Œãƒ­ã‚¹
}
```

### 7.2 UIå®Ÿè£…

```typescript
<div className="overflow-x-auto">
  <table className="min-w-full divide-y divide-gray-200">
    <thead className="bg-gray-50">
      <tr>
        <th className="px-4 py-2 text-left">Driver</th>
        <th className="px-4 py-2 text-left">Lap</th>
        <th className="px-4 py-2 text-left">Pit Duration</th>
        <th className="px-4 py-2 text-left">Tyre Change</th>
        <th className="px-4 py-2 text-left">Position</th>
        <th className="px-4 py-2 text-left">Time Lost</th>
      </tr>
    </thead>
    <tbody className="bg-white divide-y divide-gray-200">
      {pitStopDetails.map((pit, idx) => (
        <tr key={idx} className="hover:bg-gray-50">
          <td className="px-4 py-2">
            <div className="flex items-center gap-2">
              <div
                className="w-3 h-3 rounded-full"
                style={{ backgroundColor: `#${getDriver(pit.driver_number).team_colour}` }}
              />
              {pit.driver_name}
            </div>
          </td>
          <td className="px-4 py-2">{pit.lap_number}</td>
          <td className="px-4 py-2">{pit.pit_duration.toFixed(2)}s</td>
          <td className="px-4 py-2">
            <div className="flex items-center gap-1">
              <span
                className="px-2 py-1 rounded text-xs"
                style={{ backgroundColor: getTyreColor(pit.tyre_change.from) }}
              >
                {pit.tyre_change.from[0]}
              </span>
              â†’
              <span
                className="px-2 py-1 rounded text-xs"
                style={{ backgroundColor: getTyreColor(pit.tyre_change.to) }}
              >
                {pit.tyre_change.to[0]}
              </span>
            </div>
          </td>
          <td className="px-4 py-2">
            <div className="flex items-center gap-1">
              P{pit.position_before} â†’ P{pit.position_after}
              {pit.position_change > 0 && (
                <span className="text-green-600">+{pit.position_change}</span>
              )}
              {pit.position_change < 0 && (
                <span className="text-red-600">{pit.position_change}</span>
              )}
            </div>
          </td>
          <td className="px-4 py-2">{pit.time_lost.toFixed(1)}s</td>
        </tr>
      ))}
    </tbody>
  </table>
</div>
```

### 7.3 ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½

```typescript
const [sortConfig, setSortConfig] = useState<{
  key: keyof PitStopDetail;
  direction: 'asc' | 'desc';
}>({ key: 'lap_number', direction: 'asc' });

const sortedPitStops = [...pitStopDetails].sort((a, b) => {
  if (a[sortConfig.key] < b[sortConfig.key]) {
    return sortConfig.direction === 'asc' ? -1 : 1;
  }
  if (a[sortConfig.key] > b[sortConfig.key]) {
    return sortConfig.direction === 'asc' ? 1 : -1;
  }
  return 0;
});
```

---

## 8. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 8.1 ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥
```typescript
// React Queryã§ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 10 * 60 * 1000, // 10åˆ†ï¼ˆãƒ¬ãƒ¼ã‚¹çµ‚äº†å¾Œã¯é•·æœŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
      cacheTime: 30 * 60 * 1000, // 30åˆ†
    },
  },
});
```

### 8.2 å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®æœ€é©åŒ–
```typescript
// ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆé•·ã„ãƒ†ãƒ¼ãƒ–ãƒ«ç”¨ï¼‰
import { useVirtualizer } from '@tanstack/react-virtual';

const virtualizer = useVirtualizer({
  count: pitStopDetails.length,
  getScrollElement: () => parentRef.current,
  estimateSize: () => 50, // è¡Œã®é«˜ã•
});
```

### 8.3 ã‚°ãƒ©ãƒ•ã®æœ€é©åŒ–
```typescript
// useMemoã§ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚’æœ€é©åŒ–
const chartData = useMemo(
  () => processLapData(laps, selectedDrivers),
  [laps, selectedDrivers]
);

const degradationData = useMemo(
  () => calculateTyreDegradation(laps, stints),
  [laps, stints]
);
```

---

## 9. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³

### 9.1 ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ
```typescript
// ã‚°ãƒ©ãƒ•ã®é«˜ã•ã‚’ãƒ‡ãƒã‚¤ã‚¹ã«å¿œã˜ã¦èª¿æ•´
const chartHeight = useMediaQuery('(min-width: 768px)') ? 400 : 250;

<ResponsiveContainer width="100%" height={chartHeight}>
  <LineChart data={chartData}>
    {/* ... */}
  </LineChart>
</ResponsiveContainer>
```

### 9.2 ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
```typescript
// ãƒ¢ãƒã‚¤ãƒ«ã§ã¯æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«
<div className="overflow-x-auto -mx-4 px-4 md:mx-0 md:px-0">
  <table className="min-w-full">
    {/* ... */}
  </table>
</div>
```

---

## 10. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 10.1 ãƒ‡ãƒ¼ã‚¿ä¸åœ¨æ™‚
```typescript
if (!laps || laps.length === 0) {
  return (
    <div className="text-center py-12">
      <p className="text-gray-500">ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚</p>
    </div>
  );
}
```

### 10.2 ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
```typescript
if (isLoading) {
  return (
    <div className="space-y-4">
      <Skeleton className="h-64 w-full" />
      <Skeleton className="h-32 w-full" />
    </div>
  );
}
```

---

## 11. URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»•æ§˜

### 11.1 ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§
```
/race?
  year=2024
  &meeting=1234
  &session=5678
  &drivers=1,44,16         # é¸æŠãƒ‰ãƒ©ã‚¤ãƒãƒ¼
  &lapStart=1              # è¡¨ç¤ºç¯„å›²é–‹å§‹ãƒ©ãƒƒãƒ—
  &lapEnd=58               # è¡¨ç¤ºç¯„å›²çµ‚äº†ãƒ©ãƒƒãƒ—
  &compounds=SOFT,MEDIUM   # è¡¨ç¤ºã‚¿ã‚¤ãƒ¤ã‚³ãƒ³ãƒ‘ã‚¦ãƒ³ãƒ‰
```

### 11.2 çŠ¶æ…‹åŒæœŸ
```typescript
const [searchParams, setSearchParams] = useSearchParams();

// URLã‹ã‚‰ãƒ•ã‚£ãƒ«ã‚¿çŠ¶æ…‹ã‚’å¾©å…ƒ
const selectedDrivers = useMemo(() => {
  const driversParam = searchParams.get('drivers');
  return driversParam ? driversParam.split(',').map(Number) : [];
}, [searchParams]);

// ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´æ™‚ã«URLã‚’æ›´æ–°
const updateDriverSelection = (drivers: number[]) => {
  const newParams = new URLSearchParams(searchParams);
  newParams.set('drivers', drivers.join(','));
  setSearchParams(newParams);
};
```

---

## 12. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### 12.1 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
```typescript
describe('processLapData', () => {
  it('should filter pit out laps', () => {
    const laps = [
      { lap_number: 1, lap_duration: 95.5, is_pit_out_lap: false },
      { lap_number: 2, lap_duration: 120.0, is_pit_out_lap: true },
      { lap_number: 3, lap_duration: 94.8, is_pit_out_lap: false },
    ];
    const result = processLapData(laps, [1]);
    expect(result[1].driver_1).toBeNull(); // ãƒ”ãƒƒãƒˆã‚¢ã‚¦ãƒˆãƒ©ãƒƒãƒ—ã¯é™¤å¤–
  });
});

describe('calculateTyreDegradation', () => {
  it('should calculate degradation per lap', () => {
    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã§ãƒ‡ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—ã‚’æ¤œè¨¼
  });
});
```

---

## 13. ä»Šå¾Œã®æ‹¡å¼µ

- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°**: WebSocketã§ãƒ©ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿é…ä¿¡
- **æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰**: ç•°ãªã‚‹ãƒ¬ãƒ¼ã‚¹é–“ã§ã®ãƒ”ãƒƒãƒˆæˆ¦ç•¥æ¯”è¼ƒ
- **AIäºˆæ¸¬**: æ¬¡ã®ãƒ”ãƒƒãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ©Ÿæ¢°å­¦ç¿’ã§äºˆæ¸¬
- **3Då¯è¦–åŒ–**: ã‚µãƒ¼ã‚­ãƒƒãƒˆä¸Šã§ã®ä½ç½®æƒ…å ±ã¨é€£å‹•
