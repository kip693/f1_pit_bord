# 04. レース速度分析（セクション・ターンごと）仕様書

## 概要
本戦（Race）における各ドライバーの速度パフォーマンスを、セクターおよびターン単位で詳細に分析・可視化する機能の仕様。
`CONCEPT.md` の「2. セクション・ターンごとの速度分析」に対応する。

## 目的
- ドライバー間の速度差が「どこで」生まれているかを特定する
- コーナリング速度とストレート速度の違いを明確にする
- サーキット上の位置と速度の関係を視覚的に把握する

## 機能要件

### 1. セクタータイム比較
- **概要**: セクター1, 2, 3の各タイムをドライバー間で比較表示する。
- **表示内容**:
  - 選択したドライバーの各セクタータイム一覧
  - セクターごとの最速ドライバー（パープル）、自己ベスト（グリーン）の色分け
  - 基準ドライバー（リーダーまたは選択したドライバー）とのデルタ表示
- **データソース**: `laps` (duration_sector_1, duration_sector_2, duration_sector_3)

### 2. ミニセクター速度分析（詳細テレメトリー）
- **概要**: サーキットをより細かい区間（ミニセクター）または距離ベースで分割し、速度推移を比較する。
- **表示内容**:
  - **速度チャート**: 横軸を距離（Distance）またはラップ率（%）、縦軸を速度（Speed）とした折れ線グラフ
  - **スロットル/ブレーキ**: 速度チャートと連動して、スロットル開度とブレーキ入力の比較（可能な場合）
  - **ギア**: ギアチェンジのタイミング比較
  - **RPM**: エンジン回転数の推移
- **新機能**:
  - **系列の表示・非表示切り替え**: Speed, RPM, Throttle, Brake, Gearの各系列を個別に表示/非表示できるトグルボタン
  - **ドライバー比較**: 最大2人のドライバーを選択し、同時に表示して比較
  - **ベストラップ比較**: 各ドライバーのベストラップを自動選択して比較する機能
  - **セクター可視化**: グラフ背景にセクター1/2/3の区切りを色分けで表示
  - **ミニセクター表示**: より細かい区間（ターン、ストレート）を背景に表示してコース特性を理解しやすくする
- **操作**:
  - 比較したいドライバー（最大2人）の選択
  - 各ドライバーのラップ選択（特定のラップ、ファステストラップなど）
  - 表示する系列の選択（チェックボックスまたはトグルボタン）
  - ズーム機能（特定のコーナーを拡大して詳細を見る）
- **データソース**: `car_data` (speed, throttle, brake, n_gear, rpm), `location` (x, y, z), `laps` (duration_sector_1/2/3)

### 3. サーキットヒートマップ
- **概要**: サーキットマップ上に、速度またはドライバー間のタイム差を色（ヒートマップ）で表示する。
- **表示モード**:
  - **絶対速度**: その地点での速度を色分け（赤=速い、青=遅い など）
  - **デルタ（比較）**: 2人のドライバーを選択し、どちらが速いかを色分け（ドライバーAが速い=Aの色、Bが速い=Bの色）
- **データソース**: `location` (x, y), `car_data` (speed)

## UI/UX デザイン

### レイアウト
- **上部**: コントロールパネル
  - 対象ラップ選択（Lap X, Fastest Lap）
  - 比較ドライバー選択（Main vs Comparison）
- **左側/上段**: 速度チャート（テレメトリー）
  - グラフエリア（Speed, Throttle/Brake）
  - マウスホバーで詳細値表示
- **右側/下段**: サーキットマップ
  - 2Dコース図
  - チャートのホバー位置とマップ上の位置を同期（カーソル同期）

### インタラクション
- チャートをホバーすると、マップ上の対応する位置にマーカーが表示される
- マップ上の特定コーナーをクリックすると、チャートがその区間にズームする

## 技術的実装

### API利用
- `f1Api.carData.getCarData(session_key, driver_number)`: テレメトリーデータ取得
- `f1Api.location.getLocation(session_key, driver_number)`: 位置データ取得
- `f1Api.laps.getLaps(session_key, driver_number)`: ラップ情報取得

### データ処理
- **データの同期**: `car_data` と `location` は `date` フィールドで同期する必要がある。
- **距離の計算**: `location` データの (x, y) 座標から、スタートラインからの累積距離を計算し、横軸に使用する。
- **補間**: APIのサンプリングレートによりデータ点が異なるため、比較時には線形補間などで位置を合わせる必要がある。

### パフォーマンス考慮
- テレメトリーデータは大量になるため、必要なラップのみをオンデマンドで取得する。
- グラフ描画には `recharts` を使用するが、データ点数が多い場合はダウンサンプリングを検討する。

## 開発フェーズ
1. **フェーズ1**: セクタータイム比較テーブルの実装
2. **フェーズ2**: 1周分の速度チャート（テレメトリー）の実装
   - 基本的なテレメトリーチャート（Speed, Throttle, Brake, Gear, RPM）
   - 系列の表示・非表示切り替え機能
   - 2ドライバー比較機能（個別にラップ選択可能）
   - ベストラップ自動選択機能
   - セクター背景の可視化
3. **フェーズ3**: サーキットマップとヒートマップの実装、チャートとの連携
