# 05. レースポジション推移分析 仕様書

## 概要
本戦（Race）における各ドライバーの順位変動を時系列で可視化し、オーバーテイクやポジション変化の分析を行う機能の仕様。
`CONCEPT.md` の「3. レースポジション推移」に対応する。

## 目的
- レース全体の順位変動を一目で把握する
- オーバーテイク発生箇所とタイミングを特定する
- ドライバーのレースペースと順位の関係を理解する
- ピットストップが順位に与えた影響を分析する

## 機能要件

### 1. ポジションチャート（Position Chart）
- **概要**: ラップごとの順位変動を線グラフで表示する。
- **表示内容**:
  - **横軸**: ラップ番号（Lap Number）
  - **縦軸**: ポジション（Position）- 1位が上、20位が下
  - **線**: 各ドライバーの順位推移を色分けした線で表示
  - **マーカー**: オーバーテイク発生箇所を強調表示
  - **ピットストップ**: ピットストップしたラップにアイコン表示
- **インタラクション**:
  - ドライバー選択: 特定のドライバーのみを表示/非表示
  - ホバー: 各ポイントでドライバー名、ラップ、順位を表示
  - ズーム: 特定のラップ範囲を拡大表示
- **データソース**: `position` (position, date, driver_number)

### 2. オーバーテイク分析
- **概要**: オーバーテイクが発生したラップとドライバーを一覧表示する。
- **表示内容**:
  - **テーブル形式**:
    - ラップ番号
    - オーバーテイクしたドライバー
    - オーバーテイクされたドライバー
    - 新しいポジション
    - オーバーテイクタイプ（オントラック/ピットストップ）
  - **統計情報**:
    - 総オーバーテイク数
    - ドライバー別オーバーテイク数（成功/被）
    - ラップ別オーバーテイク発生頻度
- **フィルタリング**:
  - ドライバーでフィルタ
  - オーバーテイクタイプでフィルタ（オントラック/ピット）
  - ラップ範囲でフィルタ
- **データソース**: `position` (position, date, driver_number)

### 3. ギャップタイム表示
- **概要**: トップとのギャップ、前車とのギャップの推移を表示する。
- **表示モード**:
  - **トップとのギャップ**: リーダーからのタイム差を表示
  - **前車とのギャップ**: 直前のドライバーとのタイム差を表示
  - **次車とのギャップ**: 直後のドライバーとのタイム差を表示
- **表示内容**:
  - **折れ線グラフ**: 選択したドライバーのギャップ推移
  - **ヒートマップ**: 全ドライバーのギャップを色分けで表示
  - **数値テーブル**: ラップごとのギャップタイムを表形式で表示
- **データソース**: `laps` (lap_duration, lap_number, driver_number), `position` (position)

### 4. ポジション変動サマリー
- **概要**: レース全体のポジション変動を統計的に表示する。
- **表示内容**:
  - **ドライバー別サマリー**:
    - スタートポジション
    - 最高順位
    - 最低順位
    - フィニッシュポジション
    - 獲得ポジション（フィニッシュ - スタート）
    - 総オーバーテイク数
  - **レースハイライト**:
    - 最も順位を上げたドライバー
    - 最も順位を下げたドライバー
    - 最もオーバーテイクしたドライバー
    - 最も安定した順位を保ったドライバー
- **データソース**: `position`, `drivers`

## UI/UX デザイン

### レイアウト
```
┌─────────────────────────────────────────────────────────┐
│ ポジションチャート                                        │
│ ┌───────────────────────────────────────────────────┐   │
│ │                                                   │   │
│ │  [ドライバー選択フィルター]                         │   │
│ │                                                   │   │
│ │  ┌─────────────────────────────────────────┐     │   │
│ │  │                                         │     │   │
│ │  │   Position Chart (Line Graph)          │     │   │
│ │  │   - 横軸: Lap Number                    │     │   │
│ │  │   - 縦軸: Position (1-20)               │     │   │
│ │  │   - ピットストップマーカー               │     │   │
│ │  │                                         │     │   │
│ │  └─────────────────────────────────────────┘     │   │
│ └───────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────┤
│ オーバーテイク分析                                        │
│ ┌───────────────────────────────────────────────────┐   │
│ │ [統計カード]                                       │   │
│ │ 総オーバーテイク: 45回 | 最多: VER (8回)           │   │
│ └───────────────────────────────────────────────────┘   │
│ ┌───────────────────────────────────────────────────┐   │
│ │ [オーバーテイクテーブル]                            │   │
│ │ Lap | Overtaker | Overtaken | New Pos | Type     │   │
│ │ ─────────────────────────────────────────────     │   │
│ │  5  |   VER     |    HAM    |   2      | Track   │   │
│ │  8  |   LEC     |    SAI    |   3      | Pit     │   │
│ └───────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────┤
│ ギャップタイム分析                                        │
│ ┌───────────────────────────────────────────────────┐   │
│ │ [モード選択] ○ トップとのギャップ ○ 前車との差      │   │
│ │                                                   │   │
│ │  ┌─────────────────────────────────────────┐     │   │
│ │  │   Gap Time Chart                        │     │   │
│ │  │   - 選択したドライバーのギャップ推移     │     │   │
│ │  └─────────────────────────────────────────┘     │   │
│ └───────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### デザイン要素

#### ポジションチャート
- **線の色**: チームカラーを使用
- **線の太さ**: 選択されたドライバーは太く、その他は細く
- **マーカー**:
  - ピットストップ: 🔧 アイコン
  - オーバーテイク: ⬆️ アイコン（順位上昇）、⬇️ アイコン（順位下降）
- **背景**: セーフティカー期間を薄い黄色で表示

#### オーバーテイクテーブル
- **ヘッダー**: グラデーション背景 (`from-gray-50 to-gray-100`)
- **行**: ホバー時に背景色変化
- **タイプ表示**:
  - Track: 緑色バッジ
  - Pit: オレンジ色バッジ

#### ギャップタイムチャート
- **正のギャップ**: 赤系の色（遅れている）
- **負のギャップ**: 緑系の色（進んでいる）
- **0秒**: グレー（リーダー）

## データ処理

### ポジション計算
```typescript
interface PositionData {
  lap_number: number;
  driver_number: number;
  position: number;
  gap_to_leader: number | null;
  gap_to_ahead: number | null;
}

// ラップごとのポジションを計算
function calculatePositions(laps: Lap[]): PositionData[] {
  // 各ラップでのラップタイムの累積を計算
  // 累積タイムでソートして順位を決定
  // ギャップを計算
}
```

### オーバーテイク検出
```typescript
interface Overtake {
  lap_number: number;
  overtaker: number;
  overtaken: number;
  new_position: number;
  type: 'track' | 'pit';
}

// オーバーテイクを検出
function detectOvertakes(positions: PositionData[], pitStops: PitStop[]): Overtake[] {
  // 前のラップと比較して順位変動を検出
  // ピットストップの有無でタイプを判定
}
```

## 開発フェーズ

### Phase 1: ポジションチャート基本実装
- [ ] `position` データの取得とキャッシング
- [ ] ポジションチャートコンポーネント作成
- [ ] ドライバー選択フィルター実装
- [ ] ピットストップマーカー表示

### Phase 2: オーバーテイク分析
- [ ] オーバーテイク検出ロジック実装
- [ ] オーバーテイクテーブルコンポーネント作成
- [ ] 統計情報の計算と表示
- [ ] フィルタリング機能実装

### Phase 3: ギャップタイム分析
- [ ] ギャップ計算ロジック実装
- [ ] ギャップタイムチャートコンポーネント作成
- [ ] モード切り替え機能実装

### Phase 4: ポジション変動サマリー
- [ ] サマリー統計の計算
- [ ] サマリーカードコンポーネント作成
- [ ] レースハイライト表示

## 技術的考慮事項

### パフォーマンス
- ポジションデータは大量になる可能性があるため、仮想化（virtualization）を検討
- チャートの再描画を最小限に抑えるため、React.memoを活用

### データ整合性
- `position` データが欠損している場合の補完ロジック
- ラップタイムからポジションを推定する代替ロジック

### エッジケース
- リタイアしたドライバーの扱い
- セーフティカー期間のポジション変動
- ペナルティによる順位変動

## 参考資料
- Open F1 API: `position` エンドポイント
- F1公式: ポジション表示の標準
- 既存の分析ツール: F1-Tempo, FastF1

---

**作成日**: 2025-11-22
**バージョン**: 1.0
**関連仕様書**: `03_race_lap_pit_analysis.md`
